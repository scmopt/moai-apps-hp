# 需要予測・時系列分析システム ユーザーマニュアル

## 1. アプリケーション概要

本アプリケーションは、過去の実績データや関連する変動要因（天候、販促予定、商品属性など）を基に、将来の需要や売上を高精度に予測するためのデータ構造を管理します。商品と拠点の組み合わせごとに、時系列に沿った多角的な要因を整理し、最適な在庫計画や販売戦略の立案を支援します。

## 2. 設定項目（入力データ）

### 2.1 基本実績データ

予測の対象となる基本情報を、1時点（1レコード）単位で設定します。

| 項目名 | 説明 | 入力上の注意 |
| --- | --- | --- |
| 商品・拠点識別ID | 商品（SKU）と拠点（店舗・倉庫）を組み合わせた一意の識別子 | 例: `SKU01_東京支店` のように指定 |
| 基準日時 | データの記録または予測の対象となる日付・時間 | 日時形式で入力 |
| 予測対象実績値 | 予測したい実際の値（売上数、出荷量など） | 過去データの場合は必須。数値で入力 |

### 2.2 属性・変動要因設定（特徴量）

予測精度を向上させるための補助情報を、その性質に応じて3つのカテゴリで管理します。

#### ① 固定属性情報（静的特徴量）

商品カテゴリや地域など、時間の経過で変化しない情報です。
| 項目名 | 説明 | 入力上の注意 |
| :--- | :--- | :--- |
| 属性名 | カテゴリ、ブランド、地域、メーカーなど | 任意の名称 |
| 属性値 | その属性の具体的な内容 | 数値またはテキスト |

#### ② 予定・既知情報（将来変動要因）

祝日フラグや価格改定、販促キャンペーンなど、将来の分も事前に確定している情報です。
| 項目名 | 説明 | 入力上の注意 |
| :--- | :--- | :--- |
| 要因名 | 祝日フラグ、キャンペーン有無、予定価格など | 任意の名称 |
| 要因値 | その時点における具体的な設定値 | 数値またはテキスト |

#### ③ 実績・観測情報（過去変動要因）

過去の分は分かっているが、将来の分は予測時点では未知の情報（実績気温、サイトアクセス数など）です。
| 項目名 | 説明 | 入力上の注意 |
| :--- | :--- | :--- |
| 要因名 | 実績気温、客数、検索トレンド数など | 任意の名称 |
| 要因値 | 過去に実際に観測された値 | 数値またはテキスト |

---

## 3. 適用されるルール（制約条件）

データの入力および計算時には、以下のルールが適用されます。

* **時系列の整合性**: 同一の「商品・拠点識別ID」に対して、重複する「基準日時」のデータは入力できません。
* **将来予測の制限**:
* 「予定・既知情報」は将来の予測期間分も入力が必要ですが、「実績・観測情報」は過去分のみが計算に使用され、将来分はモデル内で推定または無視されます。


* **値の型定義**: 数値（整数・小数）およびテキスト情報の双方が利用可能ですが、計算モデルによっては数値化（フラグ化）が推奨されます。
* **実績値の扱い**: 過去モデルの学習には「予測対象実績値」が必須となります。

## 4. 評価尺度

予測モデルの性能を評価するための主要な指標を、性質ごとに整理して解説します。

### 1. 誤差の絶対量に基づく指標 (Absolute Error)

予測値と実績値のズレを直接的に評価します。

* **MAE (Mean Absolute Error: 平均絶対誤差)**
* **定義:** すべてのデータにおける「実績値と予測値の差の絶対値」の平均。
* **特徴:** 直感的に「平均してどれくらいズレているか」を表します。外れ値の影響をMSEほど強く受けません。


* **MSE (Mean Squared Error: 平均二乗誤差)**
* **定義:** 「実績値と予測値の差の二乗」の平均。
* **特徴:** 二乗するため、大きな誤差がある場合に値が跳ね上がります。大きなミスを避けたいモデルの学習によく使われます。


* **RMSE (Root Mean Squared Error: 平方根平均二乗誤差)**
* **定義:** MSEの平方根をとったもの。
* **特徴:** MSEは単位が元のデータと異なります（例：円の二乗）が、RMSEにすることで元の単位（例：円）に戻るため、解釈しやすくなります。


### 2. 比率（パーセント）に基づく指標 (Percentage Error)

データのスケール（単位の大きさ）が異なる複数の系列を比較する際に便利です。

* **MAPE (Mean Absolute Percentage Error: 平均絶対誤差率)**
* **定義:** 「誤差 ÷ 実績値」の絶対値を平均し、パーセント表示したもの。
* **特徴:** 単位に依存せず「何%ズレたか」で評価できます。ただし、実績値が0に近いデータがあると値が発散（無限大に）する欠点があります。


* **SMAPE (Symmetric Mean Absolute Percentage Error: 対称平均絶対誤差率)**
* **定義:** MAPEの分母を「(実績値 + 予測値) / 2」に調整したもの。
* **特徴:** MAPEの「実績値が小さいと過大評価される」という偏りを抑えるために考案されました。


* **WAPE (Weighted Absolute Percentage Error: 加重絶対誤差率)**
* **定義:** 「誤差の合計 ÷ 実績値の合計」で算出。
* **特徴:** 個々のデータの比率ではなく、全体のボリュームに対する誤差の割合を見ます。売上予測など、全体の合計が重要なビジネスシーンで多用されます。

### 3. スケール調整済み指標 (Scaled Error)

異なる単位や、トレンドの有無が異なる時系列データを公平に比較するために用いられます。

* **MASE (Mean Absolute Scaled Error: 平均絶対スケール誤差)**
* **定義:** MAEを「単純なナイーブ予測（前日の値をそのまま今日の予測とする手法）のMAE」で割ったもの。
* **特徴:** 1より小さければ「単純な予測よりも精度が良い」ことを意味します。時系列予測で非常に信頼性の高い指標です。

* **RMSSE (Root Mean Squared Scaled Error: 平方根平均二乗スケール誤差)**
* **定義:** MASEの考え方をRMSEに適用したもの。
* **特徴:** M5 Forecastingなどの有名なデータコンペティションでも採用されている、高度な時系列評価指標です。


### 4. 分位点（クォンタイル）に基づく指標 (Quantile Loss)

「平均値」ではなく、「80%の確率でこの値以下になる」といった確率的な予測（確率予測）を評価します。

* **SQL (Scaled Quantile Loss)**
* **特徴:** 特定の分位点（Quantile）における予測誤差を評価し、さらにデータのスケールで割って標準化したもの。


* **WQL (Weighted Quantile Loss)**
* **特徴:** 複数の分位点での誤差を統合し、全体の需要量などで重み付けしたもの。需要予測において、在庫不足リスク（高分位点）と過剰在庫リスク（低分位点）を分けて評価したい場合に有用です。


### 5. 対数を用いた指標

値の範囲が非常に広い（例：1から1,000,000まである）データの評価に適しています。

* **RMSLE (Root Mean Squared Logarithmic Error: 平方根平均二乗対数誤差)**
* **定義:** 実績値と予測値のそれぞれに対数をとってから、RMSEを計算。
* **特徴:** 「10と20の差」と「1000と2000の差」を、同じ「2倍の差」として同等に評価します。また、予測値が実績値より小さい（過小評価）場合に、ペナルティがより重くなる特性があります。


### 指標選びのヒント

* **ビジネスインパクトを重視:** WAPE / WQL
* **外れ値の影響を抑えたい:** MAE / MASE
* **大きなミスを厳しく罰したい:** RMSE / MSE
* **スケールの違う商品群を一括評価したい:** RMSSE / SMAPE


---

## 5. 出力結果

本システムにデータを投入することで、以下の情報を得ることができます。

1. **需要予測値**: 指定した将来期間における、商品・拠点ごとの予測数値。
2. **要因寄与度分析**: どの要因（キャンペーン、気温、曜日など）が予測値にどの程度影響を与えたかの分析結果。
3. **予測モデルの精度**: 過去の実績と予測を照らし合わせた際の誤差率（適合度）。
4. **異常値レポート**: 過去の実績から大きく乖離したデータポイントの抽出。

## 6. アプリケーション操作ガイド

本アプリケーションの操作画面（サイドバーおよびメインタブ）について解説します。

### 6.1 サイドバー設定

画面左側のサイドバーで、データ生成や予測設定を行います。

#### Actions
* **Sample Data Settings**: テスト用のサンプルデータを自動生成します。
    * **Number of Items**: 生成する時系列データの系列数（アイテム数）。
    * **Number of Days**: 生成するデータの期間（日数）。デフォルトは500日です。

#### Forecast Settings (アコーディオン)
予測処理に関する詳細パラメータを設定します。必要な設定を変更する際に開いてください。
* **Quality Presets**: モデル学習の品質と速度のトレードオフ設定（`fast_training`, `medium_quality` など）。
* **Time Limit**: 学習にかける時間の上限（秒）。
* **Prediction Length**: 将来の予測期間の長さ（ステップ数）。
* **Evaluation Metric**: モデル評価に使用する指標（MASE, RMSEなど）。
* **Frequency**: 時系列データの頻度（D:日次, W:週次, MS:月次, H:時間次）。

#### Visualization Settings (アコーディオン)
グラフ表示に関する設定を行います。
* **Quantile Levels**: 確率予測の信頼区間として表示する分位点（例: 0.1と0.9を選択すると、10%〜90%の範囲を表示）。
* **Max History Length**: グラフに描画する過去実績データの表示期間（直近N時点分）。

### 6.2 メイン画面タブ

#### Visualization
予測結果を時系列グラフで視覚的に確認します。サイドバーの **Visualization Settings** で表示形式を調整可能です。

#### Result
予測結果の詳細データを表形式で確認します。
* **Forecast Results**: 予測値（平均値および分位点）のデータテーブル。
* **Model Leaderboard**: 学習した各モデルの精度比較リスト。
* **Feature Importance**: どの特徴量が予測に寄与したかの重要度分析結果（計算に時間がかかる場合があります）。